# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Docker Compose - RPG Arena Backend
# Stack ComplÃ¨te: Backend + MongoDB + MongoExpress + Services
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

services:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸš€ Backend WebSocket - Application principale
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rpgarena-backend
    restart: unless-stopped
    
    depends_on:
      mongodb:
        condition: service_healthy
    
    environment:
      # Configuration ASP.NET Core
      ASPNETCORE_ENVIRONMENT: ${ASPNETCORE_ENVIRONMENT:-Production}
      ASPNETCORE_URLS: http://+:5000;https://+:5001
      
      # Configuration MongoDB (utilisÃ©e par Aspire)
      ConnectionStrings__mongodb: mongodb://rpgarena_user:rpgarena_pass@mongodb:27017/RPGArena?authSource=RPGArena
      
      # Configuration HTTPS (en production, utiliser des vrais certificats)
      ASPNETCORE_Kestrel__Certificates__Default__Path: /https/aspnetcore.pfx
      ASPNETCORE_Kestrel__Certificates__Default__Password: ${CERTIFICATE_PASSWORD:-devpassword}
    
    ports:
      - "5000:5000"   # HTTP
      - "5443:5001"   # HTTPS (mapped to 5443 on host to avoid conflicts)
    
    volumes:
      # Certificats SSL (Ã  crÃ©er en production)
      - ./docker/https:/https:ro
      # Logs
      - ./logs:/app/logs
    
    networks:
      - rpgarena-network
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    labels:
      - "project=rpgarena"
      - "tier=backend"
      - "service=websocket"


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ—„ï¸  MongoDB - Base de donnÃ©es principale
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  mongodb:
    image: mongo:8.0
    container_name: rpgarena-mongodb
    restart: unless-stopped
    
    environment:
      # Credentials admin
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      
      # Base de donnÃ©es par dÃ©faut
      MONGO_INITDB_DATABASE: RPGArena
    
    ports:
      - "27017:27017"
    
    volumes:
      # Persistance des donnÃ©es
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
      
      # Scripts d'initialisation (exÃ©cutÃ©s au premier dÃ©marrage)
      - ./docker/mongodb/init-scripts:/docker-entrypoint-initdb.d:ro
      
      # Configuration personnalisÃ©e
      - ./docker/mongodb/mongod.conf:/etc/mongod.conf:ro
    
    # Commande avec configuration custom
    command: ["mongod", "--config", "/etc/mongod.conf"]
    
    networks:
      - rpgarena-network
    
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    
    labels:
      - "project=rpgarena"
      - "tier=database"


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸŒ MongoExpress - Interface Web pour MongoDB
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  mongo-express:
    image: mongo-express:latest
    container_name: rpgarena-mongo-express
    restart: unless-stopped
    
    depends_on:
      mongodb:
        condition: service_healthy
    
    environment:
      # Connection Ã  MongoDB
      ME_CONFIG_MONGODB_SERVER: mongodb
      ME_CONFIG_MONGODB_PORT: "27017"
      ME_CONFIG_MONGODB_ADMINUSERNAME: admin
      ME_CONFIG_MONGODB_ADMINPASSWORD: admin123
      
      # Credentials MongoExpress UI
      ME_CONFIG_BASICAUTH_USERNAME: admin
      ME_CONFIG_BASICAUTH_PASSWORD: pass
      
      # Configuration UI
      ME_CONFIG_SITE_BASEURL: /
      ME_CONFIG_SITE_COOKIESECRET: rpgarena-secret-cookie
      ME_CONFIG_SITE_SESSIONSECRET: rpgarena-secret-session
    
    ports:
      - "8081:8081"
    
    networks:
      - rpgarena-network
    
    labels:
      - "project=rpgarena"
      - "tier=admin-ui"


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ”§ MongoDB Backup (optionnel - peut Ãªtre lancÃ© manuellement)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  mongodb-backup:
    image: mongo:8.0
    container_name: rpgarena-mongodb-backup
    profiles:
      - backup  # Ne dÃ©marre pas automatiquement
    
    depends_on:
      - mongodb
    
    environment:
      MONGO_HOST: mongodb
      MONGO_PORT: "27017"
      MONGO_USERNAME: rpgarena_user
      MONGO_PASSWORD: rpgarena_pass
      MONGO_DATABASE: RPGArena
      MONGO_AUTH_SOURCE: RPGArena
    
    volumes:
      - ./backups:/backups
      - ./docker/mongodb/backup-scripts:/scripts:ro
    
    networks:
      - rpgarena-network
    
    command: ["bash", "/scripts/backup.sh"]
    
    labels:
      - "project=rpgarena"
      - "tier=maintenance"


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ§ª Tests d'IntÃ©gration (optionnel - peut Ãªtre lancÃ© manuellement)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  integration-tests:
    build:
      context: .
      dockerfile: docker/testing/Dockerfile
    container_name: rpgarena-integration-tests
    profiles:
      - test  # Ne dÃ©marre pas automatiquement
    
    depends_on:
      mongodb:
        condition: service_healthy
      mongo-express:
        condition: service_started
    
    environment:
      # Configuration MongoDB
      MONGO_HOST: mongodb
      MONGO_PORT: "27017"
      MONGO_USERNAME: rpgarena_user
      MONGO_PASSWORD: rpgarena_pass
      MONGO_DATABASE: RPGArena
      MONGO_AUTH_SOURCE: RPGArena
      
      # Configuration pour les tests
      ASPNETCORE_ENVIRONMENT: Development
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
    
    networks:
      - rpgarena-network
    
    command: ["bash", "/workspace/scripts/test-integration.sh"]
    
    labels:
      - "project=rpgarena"
      - "tier=testing"


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ§ª Tests Unitaires (optionnel - peut Ãªtre lancÃ© manuellement)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  unit-tests:
    build:
      context: .
      dockerfile: docker/testing/Dockerfile
    container_name: rpgarena-unit-tests
    profiles:
      - test  # Ne dÃ©marre pas automatiquement
    
    environment:
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
    
    command: ["dotnet", "test", "--verbosity", "normal"]
    
    labels:
      - "project=rpgarena"
      - "tier=testing"


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“¦ Volumes persistants
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
volumes:
  mongodb_data:
    name: rpgarena_mongodb_data
    driver: local
  
  mongodb_config:
    name: rpgarena_mongodb_config
    driver: local


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸŒ RÃ©seau dÃ©diÃ©
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
networks:
  rpgarena-network:
    name: rpgarena-network
    driver: bridge
